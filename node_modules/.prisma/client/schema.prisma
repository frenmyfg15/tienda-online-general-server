generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int       @id @default(autoincrement())
  email            String    @unique
  password         String
  name             String?
  role             Role      @default(USER)
  stripeCustomerId String?
  addresses        Address[]
  orders           Order[]
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
}

model Address {
  id        Int      @id @default(autoincrement())
  userId    Int
  fullName  String
  street    String
  city      String
  state     String?
  zipCode   String
  country   String
  phone     String?
  createdAt DateTime @default(now())

  user   User    @relation(fields: [userId], references: [id])
  orders Order[] @relation("OrderAddress")
}

model Category {
  id          Int      @id @default(autoincrement())
  name        String
  slug        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]
}

model Product {
  id             Int     @id @default(autoincrement())
  name           String
  slug           String? @unique
  description    String? @db.Text
  price          Float
  compareAtPrice Float?
  costPrice      Float?

  stock         Int              @default(0)
  stockLocation String?
  isActive      Boolean          @default(true)
  condition     ProductCondition @default(NEW)

  image String?

  // Información comercial / catálogo
  brand   String?
  sku     String? @unique
  barcode String?
  tags    Json? // <-- antes String[], mejor Json en MySQL

  // Logística genérica
  weightKg Float?
  lengthCm Float?
  widthCm  Float?
  heightCm Float?

  // Política de garantía y devoluciones
  warrantyMonths       Int?
  returnDays           Int?
  shippingEstimateDays Int?

  // Metadatos y publishing
  publishedAt DateTime?
  isFeatured  Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // SEO básico
  seoTitle       String?
  seoDescription String?

  // Relaciones
  categoryId Int
  category   Category                @relation(fields: [categoryId], references: [id])
  orderItems OrderItem[]
  images     ProductImage[]
  variants   ProductVariant[]
  attributes ProductAttributeValue[]
}

model ProductImage {
  id        Int     @id @default(autoincrement())
  productId Int
  url       String
  alt       String?
  sortOrder Int     @default(0)

  product Product @relation(fields: [productId], references: [id])
}

model ProductVariant {
  id        Int     @id @default(autoincrement())
  productId Int
  name      String // ej: "Rojo / M"
  sku       String? @unique
  barcode   String?
  price     Float?
  stock     Int     @default(0)
  image     String?

  product Product @relation(fields: [productId], references: [id])
}

model ProductAttributeValue {
  id        Int    @id @default(autoincrement())
  productId Int
  name      String // ej: "Color"
  value     String // ej: "Rojo"

  product Product @relation(fields: [productId], references: [id])
}

model Order {
  id                    Int           @id @default(autoincrement())
  userId                Int
  addressId             Int?
  total                 Float
  status                OrderStatus   @default(PENDING)
  paymentStatus         PaymentStatus @default(PENDING)
  stripePaymentIntentId String?
  stripePaymentMethodId String?
  currency              String        @default("EUR")
  cancelReason          String?
  createdAt             DateTime      @default(now())
  updatedAt             DateTime      @updatedAt

  user    User        @relation(fields: [userId], references: [id])
  address Address?    @relation("OrderAddress", fields: [addressId], references: [id])
  items   OrderItem[]
}

model OrderItem {
  id        Int   @id @default(autoincrement())
  orderId   Int
  productId Int
  quantity  Int   @default(1)
  unitPrice Float

  order   Order   @relation(fields: [orderId], references: [id])
  product Product @relation(fields: [productId], references: [id])
}

enum Role {
  USER
  ADMIN
}

enum ProductCondition {
  NEW
  USED
}

enum OrderStatus {
  PENDING
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
}

enum PaymentStatus {
  PENDING
  REQUIRES_PAYMENT
  PAID
  FAILED
  REFUNDED
}
